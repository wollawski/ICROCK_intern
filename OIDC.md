# OIDC

**技术栈**：**\#身份验证 #数据库 #API #OAuth #Golang**

简介：实现一个bangumoe平台，提供用户注册、管理自身信息功能，同时对外提供OIDC的服务。

**功能概述**

1. ⽤户注册登录和修改信息的API，选择合适的数据库实现存储数据，户名、密码、邮箱、昵称、头像、简 介。接⼝的实现最好考虑使⽤你熟悉的语⾔的⼀个后端框架。
   - 进阶：⽤户需要提供邮箱，在注册时，你需要给⽤户发邮件，⽤户点击后才能注册成功，再次进阶，可以想办法限制⽤户请求邮件的频率。
2. 实现⼀个可以对外提供的使⽤ Authorization Code模式（Authorization Code Flow/授权码模式/OIDC 授权流）的OAuth2.0服务的功能，注意：**bangumoe作IdP**
3. 实现Refresh Token的流程、符合规范的OAuth2.0

## OIDC相关学习

让应用程序能够验证用户的身份，同时还能获取关于用户的基本信息。

OAuth 2.0 通常用于使两个不相关的应用程序能够共享信息，而不会影响用户数据。

OAuth 2.0 是一个**授权框架**，用于让第三方应用**获取用户的某些资源（如 API 数据），而不需要用户提供密码**。

OAuth 2.0 定义了多种授权流程（或称为“授权类型”），如**授权码流程**（本任务要求方式）、简化流程、密码凭证流程和客户端凭证流程。

OIDC 建立在这些授权流程之上，**增加了身份验证层**，使得 OAuth 2.0 **不仅可以用于授权，还可以用于认证。**

**OAuth 2.0授权流程：**

1. 用户在客户端上请求资源，客户端将用户重定向到 **授权服务器**（身份提供者/IdP/Identity Provider）。重定向 URL 通常包含一些参数，例如客户端 ID、回调 URL 和请求的范围。

2. 用户在**授权服务器**上登录并授权客户端访问其资源。

3. 授权服务器返回一个**授权码**，客户端使用**授权码**向**授权服务器**请求**访问令牌**。

4. 客户端使用**访问令牌**访问**资源服务器**上的数据。

**OIDC-建立在OAuth 2.0协议上的授权&验证过程：**

1. 用户转到他们想要访问的应用程序（信赖方）。
2. 用户在其用户名和密码中输入。
3. 信赖方向 **OpenID 提供程序**（授权服务器）发送请求。
4. OpenID 提供程序会验证用户的凭据并获取授权。
5. OpenID 提供程序向信赖方发送标识令牌，并且通常是访问令牌。
6. 信赖方将访问令牌发送到用户的设备。
7. 根据访问令牌和信赖方中提供的信息向用户授予访问权限。 

OAuth 2.0 提供授权，而 OIDC 提供身份验证。

OAuth 2.0 允许用户使用其帐户和 **OpenID 提供程序**访问**信赖方**，

OIDC 允许 **OpenID 提供程序**将用户配置文件传递给信赖方。

OIDC 还允许组织为其用户提供单一登录。

![完整流程](https://s2.loli.net/2025/10/03/2G3CrKxdJMLPZIw.png)

**(A)** **客户端请求授权**：

- 客户端通过向授权服务器发起请求来启动授权流程。请求中包含客户端的标识符（Client Identifier）、重定向 URI 和请求的权限范围（Scope）。这些信息告诉授权服务器，客户端希望访问哪些资源。

**(B)** **用户认证与授权**：

- 用户在授权服务器上进行身份验证（如输入用户名和密码），然后授权或拒绝客户端访问其资源。如果用户同意授权，授权服务器会生成授权码。

**(C)** **授权服务器返回授权码**：

- 一旦用户授权，授权服务器将用户重定向回客户端的重定向 URI，并附带授权码。授权码是一个临时的凭证，用于客户端请求访问令牌。

**(D)** **客户端通过授权码请求访问令牌**：

- 客户端使用步骤3中的授权码，通过向授权服务器的令牌端点发送请求来交换访问令牌。请求中还需要包括客户端标识符、客户端密钥、授权码以及重定向 URI。

**(E)** **授权服务器返回访问令牌**：

- 如果授权码有效，授权服务器将返回访问令牌和可选的刷新令牌（Refresh Token）。客户端可以使用访问令牌来访问资源服务器上的用户资源。

![带有Rsfresh_Token流程图](https://s2.loli.net/2025/10/04/I8sfCaMjOy1DKPW.png)

**(A) Authorization Grant（授权许可）**
客户端先通过用户的同意，拿到一个“授权许可”（通常是 **授权码 Authorization Code**）。
这一步需要用户交互，客户端得到一个可以换令牌的凭证。

客户端把 **授权码** 发给授权服务器。

**(B) **授权服务器验证成功后，返回：

**Access Token（访问令牌）**：短期有效，用来访问资源。

**Refresh Token（刷新令牌）**：长期有效，用来在 Access Token 过期后获取新的。

**(C)** 客户端拿着 Access Token 向资源服务器请求数据。

**(D)** 如果 Access Token 有效，资源服务器返回受保护的数据（比如用户的个人信息）。

**(E) ** 客户端可能继续用 Access Token 再次访问资源。

**(F) **当 Access Token 过期或无效时，资源服务器拒绝请求，并返回一个错误（提示令牌无效）。

**(G) **客户端检测到 Access Token 失效后，会携带 Refresh Token 向授权服务器请求新的 Access Token。

**(H) **授权服务器验证 Refresh Token，如果有效，就返回新的 Access Token（以及可选的新的 Refresh Token）。
